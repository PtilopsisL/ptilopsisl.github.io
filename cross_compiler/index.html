
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.2.4">
    
    
      
        <title>编译一个交叉编译器(cross compiler) - PtilopsisL</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f7f47774.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cross-compiler" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PtilopsisL" class="md-header__button md-logo" aria-label="PtilopsisL" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PtilopsisL
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              编译一个交叉编译器(cross compiler)
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PtilopsisL" class="md-nav__button md-logo" aria-label="PtilopsisL" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    PtilopsisL
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        首页
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    前言
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    源代码、依赖库下载/安装
  </a>
  
    <nav class="md-nav" aria-label="源代码、依赖库下载/安装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    源代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    依赖库(不需要源代码)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    需预先了解的知识
  </a>
  
    <nav class="md-nav" aria-label="需预先了解的知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#buildhosttarget" class="md-nav__link">
    build、host与target
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cpu-company-system" class="md-nav__link">
    cpu-company-system格式
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    编译过程
  </a>
  
    <nav class="md-nav" aria-label="编译过程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1.设置变量
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2binutils" class="md-nav__link">
    2.编译binutils
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3linux-headers" class="md-nav__link">
    3.安装linux-headers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4ccgcc" class="md-nav__link">
    4.C/C++编译器(gcc第一遍编译)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5cstartup-filesglibc" class="md-nav__link">
    5.C库头文件与Startup Files(glibc第一遍)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6gccgcc" class="md-nav__link">
    6.编译gcc库(gcc第二遍编译)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7cglibc" class="md-nav__link">
    7.标准C库(glibc第二遍)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8c" class="md-nav__link">
    8.标准C++库
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    完整脚本
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    结果
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="cross-compiler">编译一个交叉编译器(cross compiler)<a class="headerlink" href="#cross-compiler" title="Permanent link">&para;</a></h1>
<p>教程参考<a href="https://preshing.com/20141119/how-to-build-a-gcc-cross-compiler/">https://preshing.com/20141119/how-to-build-a-gcc-cross-compiler/</a></p>
<h2 id="_1">前言<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<ul>
<li>这里尝试的是在<code>Linux</code>系统中编译一个生成<code>Linux</code>可执行文件的交叉编译器，未尝试过编译<code>target</code>为<code>mingw32</code>或<code>cygwin</code>的交叉编译器。</li>
<li>如果只想让编译器编译出汇编代码，不需要执行完所有的步骤。以下两种方法均能实现从源文件生成汇编代码，但你的源文件中不能使用标准库中的函数，如<code>printf</code>等，或者可以自行安装标准库包含的头文件。<ul>
<li>使用<code>clang</code>。可以直接安装<code>clang</code>来生成汇编代码，生成方式如<code>clang -S -target riscv64 test.c -o test.s</code>。这里通过指定<code>-target</code>的方式来生成相应的汇编代码，只需要把<code>-target</code>指定的内容换成其他名称如<code>aarch64 riscv32</code>等就能编译出相应指令集的汇编代码。</li>
<li>执行完<code>gcc</code>的第一次编译安装，即执行完<code>make install-gcc</code>后就结束。生成汇编的方式：<code>riscv64-pc-linux-gcc -S test.c -o test.s</code>。这里<code>gcc</code>前面的<code>riscv64-pc-linux</code>是你指定的<code>-target</code>。</li>
</ul>
</li>
<li>最好不要在WSL环境中进行编译。因为某一些原因，最后在执行<code>glibc</code>的第二遍编译的时候会出错。使用其他虚拟机能避免这个问题。</li>
<li>交叉编译过程未在<code>Cygwin</code>、<code>MinGW</code>中测试过，可行性未知。</li>
</ul>
<h2 id="_2">源代码、依赖库下载/安装<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">源代码<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>这次编译需要的源代码有：</p>
<ul>
<li><code>binutils</code></li>
<li><code>gcc</code></li>
<li><code>glibc</code></li>
<li><code>linux</code></li>
</ul>
<p>以上内容均可以从镜像源中获取，获取方式：
<div class="highlight"><pre><span></span><code>wget https://mirrors.ustc.edu.cn/gnu/binutils/binutils-2.37.tar.gz
wget https://mirrors.ustc.edu.cn/gnu/gcc/gcc-9.4.0/gcc-9.4.0.tar.gz
wget https://mirrors.ustc.edu.cn/gnu/glibc/glibc-2.31.tar.gz
git clone https://mirrors.ustc.edu.cn/linux.git
</code></pre></div></p>
<ul>
<li>这里<code>glibc</code>为了兼容性建议选<code>2.31</code>版本，当然如果你不打算把用交叉编译器编译出的程序放到别的机器上运行，则可以不用考虑兼容性，或者在用交叉编译器编译的时候指定<code>-static</code>选项。</li>
<li><code>Linux</code>源代码在本次编译中只用于安装头文件，如果认为<code>clone</code>整个代码库占用空间太大，可以下载源代码<code>tarball</code>。</li>
<li><code>gcc</code>9版本与10版本都经过测试能成功编译，其他版本未测试过可行性。</li>
</ul>
<h3 id="_4">依赖库(不需要源代码)<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>需要的依赖库有：</p>
<ul>
<li><code>gmp</code></li>
<li><code>mpfr</code></li>
<li><code>mpc</code></li>
</ul>
<p>在本次编译过程中不需要以上依赖库的源代码，因此可以自己从源代码安装或直接使用包管理器安装。在以<code>apt</code>为包管理器的系统上可执行：
<div class="highlight"><pre><span></span><code>sudo apt install libgmp-dev libmpfr-dev libmpc-dev
</code></pre></div></p>
<h2 id="_5">需预先了解的知识<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="buildhosttarget"><code>build</code>、<code>host</code>与<code>target</code><a class="headerlink" href="#buildhosttarget" title="Permanent link">&para;</a></h3>
<p>一般在编译库的时候只有<code>build</code>和<code>target</code>两个选项，在编译编译器的时候则有以上三个选项。这三个选项的意义是：在<code>build</code>机器上编译出能在<code>host</code>机器上运行，生成<code>target</code>机器代码的编译器。</p>
<h3 id="cpu-company-system"><code>cpu-company-system</code>格式<a class="headerlink" href="#cpu-company-system" title="Permanent link">&para;</a></h3>
<p>指定<code>host</code>或<code>target</code>需要按照上述格式来指定，当然其中最重要的还是<code>cpu</code>和<code>system</code>两个部分，<code>company</code>似乎是可以随便写的。</p>
<ul>
<li><code>cpu</code>：填写指令集名称，如<code>aarch64</code>、<code>riscv32</code>、<code>mips64</code>等。</li>
<li><code>company</code>：可以用<code>gcc -v</code>看一看自己编译器中的<code>company</code>是什么（一般来说是<code>pc</code>）然后填上去，或者直接指定为<code>unknown</code>。</li>
<li><code>system</code>：这里填写的内容主要决定的是程序的运行格式，<code>Linux</code>系统的可执行文件格式是<code>elf</code>，这里填写<code>linux</code>、<code>gnu</code>或<code>elf</code>都是差不多的。</li>
</ul>
<p><code>gcc</code>支持的所有<code>cpu</code>与<code>system</code>类型可以查看<a href="https://gcc.gnu.org/install/configure.html">https://gcc.gnu.org/install/configure.html</a>。</p>
<h2 id="_6">编译过程<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>这里会详细介绍一下编译过程，最后会给出一个完整的脚本。</p>
<h3 id="1">1.设置变量<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p><div class="highlight"><pre><span></span><code><span class="nv">WORKING_DIR</span><span class="o">=</span><span class="nv">$PWD</span>

<span class="nv">LINUX_ARCH</span><span class="o">=</span>riscv
<span class="nv">TARGET</span><span class="o">=</span>riscv64-pc-linux
<span class="nv">PREFIX</span><span class="o">=</span><span class="nv">$PWD</span>/usr
<span class="nv">TARGET_PREFIX</span><span class="o">=</span><span class="nv">$PREFIX</span>/<span class="nv">$TARGET</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$PREFIX</span>/bin
<span class="nv">PARALLEL_MAKE</span><span class="o">=</span>-j8
<span class="nv">CONFIGURATION_OPTIONS</span><span class="o">=</span><span class="s2">&quot;--disable-multilib --disable-threads&quot;</span>

<span class="nv">BINUTILS</span><span class="o">=</span>binutils-2.37
<span class="nv">GCC</span><span class="o">=</span>gcc-10.3.0
<span class="nv">GLIBC</span><span class="o">=</span>glibc-2.34
<span class="nv">LINUX</span><span class="o">=</span>linux-stable
</code></pre></div>
说明：</p>
<ul>
<li><code>LINUX_ARCH</code>是目标机器指令集名称，该名称需要查看<code>Linux</code>源代码中的<code>arch</code>文件夹，找到相对应的名称。比如说<code>aarch64</code>不能直接填<code>aarch64</code>，应当填写<code>arm64</code>。</li>
<li><code>TARGET</code>即为先前介绍过的<code>cpu-company-system</code>格式。</li>
<li><code>PREFIX</code>为安装文件夹。</li>
<li>如果编译环境的内存不是很充足，建议将<code>PARALLEL_MAKE</code>的并行数改小一点。</li>
<li><code>CONFIGURATION_OPTIONS</code>中的<code>--disable-multilib --disable-threads</code>最好加上，否则可能会出现问题。如果想让编译器加上编译多线程程序的功能，可以执行完一次完整编译之后再进行。</li>
</ul>
<h3 id="2binutils">2.编译binutils<a class="headerlink" href="#2binutils" title="Permanent link">&para;</a></h3>
<p>这一步编译出的是<code>as</code>、<code>ld</code>等工具，在本机上可以运行的处理<code>target</code>机器代码的工具。
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$BINUTILS</span>
mkdir build
<span class="nb">cd</span> build
../configure --prefix<span class="o">=</span><span class="nv">$PREFIX</span> --target<span class="o">=</span><span class="nv">$TARGET</span> <span class="nv">$CONFIGURATION_OPTIONS</span>
make <span class="si">${</span><span class="nv">PARALLEL_MAKE</span><span class="si">}</span>
make install
</code></pre></div></p>
<h3 id="3linux-headers">3.安装linux-headers<a class="headerlink" href="#3linux-headers" title="Permanent link">&para;</a></h3>
<p>这一步安装的是<code>Linux</code>头文件，不需要编译内核源代码。
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$LINUX</span>
make <span class="nv">ARCH</span><span class="o">=</span><span class="si">${</span><span class="nv">LINUX_ARCH</span><span class="si">}</span> <span class="nv">INSTALL_HDR_PATH</span><span class="o">=</span><span class="nv">$TARGET_PREFIX</span> headers_install
</code></pre></div></p>
<h3 id="4ccgcc">4.C/C++编译器(gcc第一遍编译)<a class="headerlink" href="#4ccgcc" title="Permanent link">&para;</a></h3>
<p>第一遍编译的内容只包含编译器，不包含相关的依赖等。
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$GCC</span>
rm -rf build
mkdir build
<span class="nb">cd</span> build
../configure --target<span class="o">=</span><span class="nv">$TARGET</span> --prefix<span class="o">=</span><span class="nv">$PREFIX</span> <span class="nv">$CONFIGURATION_OPTIONS</span> --enable-languages<span class="o">=</span>c,c++
make <span class="si">${</span><span class="nv">PARALLEL_MAKE</span><span class="si">}</span> all-gcc
make install-gcc
</code></pre></div></p>
<h3 id="5cstartup-filesglibc">5.C库头文件与Startup Files(glibc第一遍)<a class="headerlink" href="#5cstartup-filesglibc" title="Permanent link">&para;</a></h3>
<p>这一步是安装头文件再加上Startup Files，这些是编译器进行编译的必要条件。
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$GLIBC</span>
rm -rf build
mkdir build
<span class="nb">cd</span> build
../configure --host<span class="o">=</span><span class="nv">$TARGET</span> --target<span class="o">=</span><span class="nv">$TARGET</span> --prefix<span class="o">=</span><span class="nv">$PREFIX</span>/<span class="nv">$TARGET</span> --with-headers<span class="o">=</span><span class="nv">$TARGET_PREFIX</span>/include <span class="nv">$CONFIGURATION_OPTIONS</span> <span class="nv">CC</span><span class="o">=</span><span class="si">${</span><span class="nv">TARGET</span><span class="si">}</span>-gcc
make install-headers
make <span class="nv">$PARALLEL_MAKE</span> csu/subdir_lib
install csu/crt1.o csu/crti.o csu/crtn.o <span class="nv">$PREFIX</span>/<span class="nv">$TARGET</span>/lib
<span class="nv">$TARGET</span>-gcc -nostdlib -nostartfiles -shared -x c /dev/null -o <span class="nv">$PREFIX</span>/<span class="nv">$TARGET</span>/lib/libc.so
</code></pre></div></p>
<h3 id="6gccgcc">6.编译gcc库(gcc第二遍编译)<a class="headerlink" href="#6gccgcc" title="Permanent link">&para;</a></h3>
<p>这一步会编译出<code>libgcc</code>，这个库会在后续完整编译<code>glibc</code>时会用到。
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$GCC</span>
<span class="nb">cd</span> build
make <span class="nv">$PARALLEL_MAKE</span> all-target-libgcc
make install-target-libgcc
</code></pre></div></p>
<h3 id="7cglibc">7.标准C库(glibc第二遍)<a class="headerlink" href="#7cglibc" title="Permanent link">&para;</a></h3>
<p>这一步会完整编译出C基础库。
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$GLIBC</span>
<span class="nb">cd</span> build
make <span class="nv">$PARALLEL_MAKE</span>
make install
</code></pre></div></p>
<h3 id="8c">8.标准C++库<a class="headerlink" href="#8c" title="Permanent link">&para;</a></h3>
<p>在编译之前需要修改源代码中的<code>libsanitizer/asan/asan_linux.cc</code>（<code>gcc-9</code>与<code>gcc-10</code>都需要修改这个部分，或许其他版本也要加），在开头位置加入：
<div class="highlight"><pre><span></span><code><span class="cp">#ifndef PATH_MAX</span>
<span class="cp">#define PATH_MAX 4096</span>
<span class="cp">#endif</span>
</code></pre></div>
修改完之后可以开始编译：
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$GCC</span>
<span class="nb">cd</span> build
make <span class="nv">$PARALLEL_MAKE</span> all
make install
</code></pre></div></p>
<h3 id="_7">完整脚本<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>经测试，这个脚本可以成功执行整个编译的过程。但还是建议按照上述步骤一步一步执行，避免中途出现一些问题。</p>
<p>执行前需要先按照先前的说明，对环境变量进行一些修改。
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="nb">export</span> <span class="nv">WORKING_DIR</span><span class="o">=</span><span class="nv">$PWD</span>

<span class="nb">export</span> <span class="nv">LINUX_ARCH</span><span class="o">=</span>riscv
<span class="nb">export</span> <span class="nv">TARGET</span><span class="o">=</span>riscv64-pc-linux
<span class="nb">export</span> <span class="nv">PREFIX</span><span class="o">=</span><span class="nv">$PWD</span>/usr
<span class="nb">export</span> <span class="nv">TARGET_PREFIX</span><span class="o">=</span><span class="nv">$PREFIX</span>/<span class="nv">$TARGET</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$PREFIX</span>/bin
<span class="nb">export</span> <span class="nv">PARALLEL_MAKE</span><span class="o">=</span>-j8
<span class="nb">export</span> <span class="nv">CONFIGURATION_OPTIONS</span><span class="o">=</span><span class="s2">&quot;--disable-multilib --disable-threads&quot;</span>

<span class="nb">export</span> <span class="nv">BINUTILS</span><span class="o">=</span>binutils-2.37
<span class="nb">export</span> <span class="nv">GCC</span><span class="o">=</span>gcc-10.3.0
<span class="nb">export</span> <span class="nv">GLIBC</span><span class="o">=</span>glibc-2.34
<span class="nb">export</span> <span class="nv">LINUX</span><span class="o">=</span>linux-stable

<span class="nb">echo</span> -e <span class="s2">&quot;\e[1;31mUnpack tarball? (y/n)\e[0m&quot;</span>
<span class="nb">read</span> input
<span class="k">if</span> <span class="o">[</span> <span class="nv">$input</span> <span class="o">=</span> y <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="nv">$input</span> <span class="o">=</span> Y <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    tar -xvf <span class="si">${</span><span class="nv">BINUTILS</span><span class="si">}</span>.tar.gz
    tar -xvf <span class="si">${</span><span class="nv">GCC</span><span class="si">}</span>.tar.gz
    tar -xvf <span class="si">${</span><span class="nv">GLIBC</span><span class="si">}</span>.tar.gz
    <span class="nb">echo</span> -e <span class="s2">&quot;\e[1;31mFinish unpack.\e[0m&quot;</span>
<span class="k">fi</span>

<span class="nb">cd</span> <span class="nv">$BINUTILS</span>
rm -rf build
mkdir build
<span class="nb">cd</span> build
../configure --prefix<span class="o">=</span><span class="nv">$PREFIX</span> --target<span class="o">=</span><span class="nv">$TARGET</span> <span class="nv">$CONFIGURATION_OPTIONS</span>
make <span class="si">${</span><span class="nv">PARALLEL_MAKE</span><span class="si">}</span>
make install

<span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$LINUX</span>
make <span class="nv">ARCH</span><span class="o">=</span><span class="si">${</span><span class="nv">LINUX_ARCH</span><span class="si">}</span> <span class="nv">INSTALL_HDR_PATH</span><span class="o">=</span><span class="nv">$TARGET_PREFIX</span> headers_install

<span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$GCC</span>
rm -rf build
mkdir build
<span class="nb">cd</span> build
../configure --target<span class="o">=</span><span class="nv">$TARGET</span> --prefix<span class="o">=</span><span class="nv">$PREFIX</span> <span class="nv">$CONFIGURATION_OPTIONS</span> --enable-languages<span class="o">=</span>c,c++
make <span class="si">${</span><span class="nv">PARALLEL_MAKE</span><span class="si">}</span> all-gcc
make install-gcc

<span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$GLIBC</span>
rm -rf build
mkdir build
<span class="nb">cd</span> build
../configure --host<span class="o">=</span><span class="nv">$TARGET</span> --target<span class="o">=</span><span class="nv">$TARGET</span> --prefix<span class="o">=</span><span class="nv">$PREFIX</span>/<span class="nv">$TARGET</span> --with-headers<span class="o">=</span><span class="nv">$TARGET_PREFIX</span>/include <span class="nv">$CONFIGURATION_OPTIONS</span> <span class="nv">CC</span><span class="o">=</span><span class="si">${</span><span class="nv">TARGET</span><span class="si">}</span>-gcc
make install-headers
make <span class="nv">$PARALLEL_MAKE</span> csu/subdir_lib
install csu/crt1.o csu/crti.o csu/crtn.o <span class="nv">$PREFIX</span>/<span class="nv">$TARGET</span>/lib
<span class="nv">$TARGET</span>-gcc -nostdlib -nostartfiles -shared -x c /dev/null -o <span class="nv">$PREFIX</span>/<span class="nv">$TARGET</span>/lib/libc.so

<span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$GCC</span>
<span class="nb">cd</span> build
make <span class="nv">$PARALLEL_MAKE</span> all-target-libgcc
make install-target-libgcc

<span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$GLIBC</span>
<span class="nb">cd</span> build
make <span class="nv">$PARALLEL_MAKE</span>
make install

<span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">cd</span> <span class="nv">$GCC</span>
<span class="nb">cd</span> build
make <span class="nv">$PARALLEL_MAKE</span> all
make install

<span class="nb">cd</span> <span class="nv">$WORKING_DIR</span>
<span class="nb">echo</span> -e <span class="s2">&quot;\e[1;31mSuccess\e[0m&quot;</span>
</code></pre></div></p>
<h2 id="_8">结果<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>执行完一次<code>target</code>为<code>riscv64</code>的交叉编译器的编译，使用它编译一个输出<code>Hello world!</code>的C文件，执行反汇编后输出如下的结果：
<div class="highlight"><pre><span></span><code>$ llvm-objdump -d hello
hello:  file format ELF64-riscv


Disassembly of section .plt:

00000000000103f0 _PROCEDURE_LINKAGE_TABLE_:
   103f0: 97 23 00 00 33 03 c3 41         .#..3..A
   103f8: 03 be 03 c1 13 03 43 fd         ......C.
   10400: 93 82 03 c1 13 53 13 00         .....S..
   10408: 83 b2 82 00 67 00 0e 00         ....g...
   10410: 17 2e 00 00 03 3e 0e c0         .....&gt;..
   10418: 67 03 0e 00 13 00 00 00         g.......
   10420: 17 2e 00 00 03 3e 8e bf         .....&gt;..
   10428: 67 03 0e 00 13 00 00 00         g.......

Disassembly of section .text:

0000000000010430 _start:
   10430: ef 00 20 02                   jal 34
   10434: aa 87                         add a5, zero, a0
   10436: 17 05 00 00                   auipc   a0, 0
   1043a: 13 05 e5 08                   addi    a0, a0, 142
   1043e: 82 65                         ld  a1, 0(sp)
   10440: 30 00                         addi    a2, sp, 8
   10442: 13 71 01 ff                   andi    sp, sp, -16
   10446: 81 46                         mv  a3, zero
   10448: 01 47                         mv  a4, zero
   1044a: 0a 88                         add a6, zero, sp
   1044c: ef f0 5f fc                   jal -60
   10450: 02 90                         ebreak  

0000000000010452 load_gp:
   10452: 97 21 00 00                   auipc   gp, 2
   10456: 93 81 e1 3a                   addi    gp, gp, 942
   1045a: 82 80                         ret
   1045c: 00 00                         unimp   

000000000001045e deregister_tm_clones:
   1045e: 49 65                         lui a0, 18
   10460: 49 67                         lui a4, 18
   10462: 93 07 05 00                   mv  a5, a0
   10466: 13 07 07 00                   mv  a4, a4
   1046a: 63 08 f7 00                   beq a4, a5, 16
   1046e: 93 07 00 00                   mv  a5, zero
   10472: 81 c7                         beqz    a5, 8
   10474: 13 05 05 00                   mv  a0, a0
   10478: 82 87                         jr  a5
   1047a: 82 80                         ret

000000000001047c register_tm_clones:
   1047c: 49 65                         lui a0, 18
   1047e: 93 07 05 00                   mv  a5, a0
   10482: 49 67                         lui a4, 18
   10484: 93 05 07 00                   mv  a1, a4
   10488: 9d 8d                         sub a1, a1, a5
   1048a: 93 d7 35 40                   srai    a5, a1, 3
   1048e: fd 91                         srli    a1, a1, 63
   10490: be 95                         add a1, a1, a5
   10492: 85 85                         srai    a1, a1, 1
   10494: 99 c5                         beqz    a1, 14
   10496: 93 07 00 00                   mv  a5, zero
   1049a: 81 c7                         beqz    a5, 8
   1049c: 13 05 05 00                   mv  a0, a0
   104a0: 82 87                         jr  a5
   104a2: 82 80                         ret

00000000000104a4 __do_global_dtors_aux:
   104a4: 41 11                         addi    sp, sp, -16
   104a6: 22 e0                         sd  s0, 0(sp)
   104a8: 83 c7 81 83                   lbu a5, -1992(gp)
   104ac: 06 e4                         sd  ra, 8(sp)
   104ae: 91 e7                         bnez    a5, 12
   104b0: ef f0 ff fa                   jal -82
   104b4: 85 47                         addi    a5, zero, 1
   104b6: 23 8c f1 82                   sb  a5, -1992(gp)
   104ba: a2 60                         ld  ra, 8(sp)
   104bc: 02 64                         ld  s0, 0(sp)
   104be: 41 01                         addi    sp, sp, 16
   104c0: 82 80                         ret

00000000000104c2 frame_dummy:
   104c2: 6d bf                         j   -70

00000000000104c4 main:
   104c4: 41 11                         addi    sp, sp, -16
   104c6: 06 e4                         sd  ra, 8(sp)
   104c8: 22 e0                         sd  s0, 0(sp)
   104ca: 00 08                         addi    s0, sp, 16
   104cc: c1 67                         lui a5, 16
   104ce: 13 85 87 4e                   addi    a0, a5, 1256
   104d2: ef f0 ff f4                   jal -178
   104d6: 81 47                         mv  a5, zero
   104d8: 3e 85                         add a0, zero, a5
   104da: a2 60                         ld  ra, 8(sp)
   104dc: 02 64                         ld  s0, 0(sp)
   104de: 41 01                         addi    sp, sp, 16
   104e0: 82 80                         ret
</code></pre></div>
可以看到成功生成了<code>riscv64</code>的代码。</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.709b4209.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.febc23d1.min.js"></script>
      
    
  </body>
</html>